cd @CMAKE_INSTALL_PREFIX@
echo "Creating Spheral virtual python environment ..."

env PYTHONPATH=@BUILDTIME_PYTHONENV_STR@ @PYTHON_EXE@ -m virtualenv -p @PYTHON_EXE@ .venv --no-pip --no-wheel --no-setuptools

echo "Copy pip from current site-packages ..."
cp -r @PYTHON_SITE_PACKAGE_DIR@/* .venv/lib/python2.7/site-packages/

echo "Copy setuptools from setuptools_DIR ..."
cp -r @setuptools_DIR@/* .venv/lib/python2.7/site-packages/

echo "Copy wheel from wheel_DIR ..."
cp -r @wheel_DIR@/* .venv/lib/python2.7/site-packages/

echo "Copy pyb11generator from pyb11generator_DIR ..."
cp -r @pyb11generator_DIR@/* .venv/lib/python2.7/site-packages/

#echo "Activating virtual environment"
#source @CMAKE_INSTALL_PREFIX@/.venv/bin/activate

echo "Installing runtime python dependencies from generatoed requirements.txt ..."
@CMAKE_INSTALL_PREFIX@/.venv/bin/python -m pip download -r scripts/requirements.txt --no-binary :all -d @CACHE_DIR@
@CMAKE_INSTALL_PREFIX@/.venv/bin/python -m pip install -r scripts/requirements.txt --no-index --find-links @CACHE_DIR@

echo "Installing custom runtime python dependencies : gnuplot, ats ..."
wget @GNUPLOT_URL@ --no-check-certificate -O @GNUPLOT_CACHE@ > @GNUPLOT_CACHE@-download.log
@CMAKE_INSTALL_PREFIX@/.venv/bin/python -m pip install @GNUPLOT_CACHE@ --no-index --find-links @CACHE_DIR@
wget @ATS_URL@ --no-check-certificate -O @ATS_CACHE@ > @ATS_CACHE@-download.log
@CMAKE_INSTALL_PREFIX@/.venv/bin/python -m pip install @ATS_CACHE@ --no-index --find-links @CACHE_DIR@

echo "Installing Spheral ..."
cp @polytope_DIR@/lib/python2.7/site-packages/polytope/polytope.so @CMAKE_INSTALL_PREFIX@/.venv/lib/python2.7/site-packages/
cp Spheral.pth .venv/lib/python2.7/site-packages/
mkdir -p .venv/lib/python2.7/site-packages/Spheral

cd @CMAKE_INSTALL_PREFIX@/.venv/lib/python2.7/site-packages/Spheral
cp --symbolic-link @CMAKE_INSTALL_PREFIX@/Spheral/* . > /dev/null 2>&1
cd - > /dev/null 

echo "Creating spheral symlink to spheral-env script ..."
cd @CMAKE_INSTALL_PREFIX@
chmod u+x scripts/spheral-env.sh
chmod u+x scripts/atstest.sh
cp --symbolic-link scripts/spheral-env.sh spheral
cp --symbolic-link scripts/atstest.sh atstest
cd - > /dev/null 

